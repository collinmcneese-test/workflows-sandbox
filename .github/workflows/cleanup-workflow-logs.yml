name: 'ðŸ”‡ Clean Logs'

on:
  workflow_dispatch:
    inputs:
      clean_logs:
        type: boolean
        default: true
      # clean_deployments:
      #   type: boolean
      #   default: false

permissions: {}

jobs:
  # This job will delete all workflow runs for the current repository
  # Get a list of all workflow runs for the current repository
  # Loop through each workflow run and delete the runs
  cleanup-runs:
    if: ${{ inputs.clean_logs == true }}
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = process.env.GITHUB_REPOSITORY.split("/")[0];
            const repo = process.env.GITHUB_REPOSITORY.split("/")[1];
            const runs = await github.paginate(github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              status: "completed",
              per_page: 100
            }));

            for (const run of runs) {
              await github.rest.actions.deleteWorkflowRun({
                owner,
                repo,
                run_id: run.id
              });
            }
  complete:
    needs:
      - cleanup-runs
    runs-on: ubuntu-latest
    steps:
      - name: Report rate-limit
        uses: collinmcneese/actions-rate-limit-reporter@main
        with:
          access-token: ${{ secrets.GITHUB_TOKEN }}
